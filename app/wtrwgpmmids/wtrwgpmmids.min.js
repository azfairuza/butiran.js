var btLoad,btRead,btRun,btInfo,taIn,taOut,caOut,caOut2,N,xx,yy,dd,cc,hh,ii,xmin,ymin,xmax,ymax,XMIN,YMIN,XMAX,YMAX,xmin2,ymin2,xmax2,ymax2,XMIN2,YMIN2,XMAX2,YMAX2,proc,iter,Niter,D,vmax,TRCV,NINF,S,I,R,pname="WTRWGPMMIDS",bgColor="#f8f8f8",colors=["#888","#f88","#88f","#8f8"];function main(){cout("Program start"),layout(),initParams()}function simulate(){iter>=Niter&&(clearInterval(proc),stateButton(1,1,1,1),btRun.innerHTML="Run");var t=getSIR();tout(("0000"+iter).slice(-4)+" "+("0000"+t[0]).slice(-4)+" "+("0000"+t[1]).slice(-4)+" "+("0000"+t[2]).slice(-4)+"\n"),S.push(t[0]),I.push(t[1]),R.push(t[2]),changePositions(),developeImmunity(),propagateInfection(),clearX(),drawPositions(),clearX2(),drawSIRChart(),iter++}function developeImmunity(){for(var t=0;t<N;t++){(ii[t]>-1?iter-ii[t]:0)>TRCV&&(hh[t]=1,cc[t]=colors[hh[t]+2])}}function propagateInfection(){for(var t=0;t<N;t++)for(var n=t+1;n<N;n++){var a=xx[t],e=yy[t],i=.5*dd[t],o=a-xx[n],r=e-yy[n],c=i+.5*dd[n]-Math.sqrt(o*o+r*r);(c=c<0?0:c)>0&&(-1==hh[t]&&0==hh[n]&&(hh[n]=hh[t],cc[n]=cc[t],ii[n]=iter),-1==hh[n]&&0==hh[t]&&(hh[t]=hh[n],cc[t]=cc[n],ii[t]=iter))}}function changePositions(){for(var t=0;t<N;t++){var n=xx[t],a=yy[t],e=.5*dd[t],i=2*Math.PI*Math.random(),o=n+1*(vmax*Math.cos(i)),r=a+1*(vmax*Math.sin(i));(o<xmin+e||xmax-e<o)&&(o=n),(r<ymin+e||ymax-e<r)&&(r=a),xx[t]=o,yy[t]=r}}function getSIR(){for(var t=0,n=0,a=0,e=0;e<N;e++)-1==hh[e]&&t++,0==hh[e]&&n++,1==hh[e]&&a++;return[n,t,a]}function initParams(){xmin=0,ymin=0,xmax=300,ymax=300,XMIN=0,YMIN=parseInt(caOut.height),XMAX=parseInt(caOut.width),YMAX=0,xmin2=0,ymin2=0,xmax2=1,ymax2=1,XMIN2=-4,YMIN2=parseInt(caOut2.height)-4,XMAX2=parseInt(caOut2.width)+4,YMAX2=4}function loadParams(){tin("# Population\nNPOP 1600\nNINF 100\nTRCV 50\n\n# Individu\nVMAX 1\n\n# Simulation\nTSIM 200\n")}function readParams(){for(var t=taIn.value.split("\n"),n=0;n<t.length;n++){var a=t[n].split(" ");"NPOP"==a[0]&&(N=parseInt(a[1])),"NINF"==a[0]&&(NINF=parseInt(a[1])),"TRCV"==a[0]&&(TRCV=parseInt(a[1])),"VMAX"==a[0]&&(vmax=parseInt(a[1])),"TSIM"==a[0]&&(Niter=parseInt(a[1]))}xmax2=Niter,S=[],I=[],R=[]}function initPositions(){var t=Math.floor(Math.sqrt(N)),n=t,a=(xmax-xmin)/t,e=(ymax-ymin)/n;D=.34*(a+e),xx=[],yy=[],dd=[],cc=[],hh=[],ii=[];for(var i=0;i<n;i++){for(var o=0;o<t;o++){var r=(o+.5)*a,c=(i+.5)*e;r+=.2*D*(Math.random()-.5),c+=.2*D*(Math.random()-.5),xx.push(r),yy.push(c),dd.push(D),hh.push(0),ii.push(-1),cc.push(colors[2])}S=[],I=[],R=[]}for(var u=0;u<NINF;u++){var l=Math.floor(Math.random()*N);hh[l]=-1,cc[l]=colors[hh[l]+2],ii[l]=0}}function drawSIRChart(){var t=caOut2.getContext("2d"),n=S.length;t.lineWidth="2",t.strokeStyle=colors[2],t.beginPath();for(var a=0;a<n;a++){var e=c(a),i=u(S[a]/N);0==a?t.moveTo(e,i):t.lineTo(e,i)}t.stroke();var o=I.length;t.strokeStyle=colors[1],t.lineWidth="2",t.beginPath();for(a=0;a<o;a++){e=c(a),i=u(I[a]/N);0==a?t.moveTo(e,i):t.lineTo(e,i)}t.stroke();var r=R.length;t.strokeStyle=colors[3],t.lineWidth="2",t.beginPath();for(a=0;a<r;a++){e=c(a),i=u(R[a]/N);0==a?t.moveTo(e,i):t.lineTo(e,i)}function c(t){var n=(t-xmin2)/(xmax2-xmin2);return n*=XMAX2-XMIN2,n+=XMIN2}function u(t){var n=(t-ymin2)/(ymax2-ymin2);return n*=YMAX2-YMIN2,n+=YMIN2}t.stroke()}function drawPositions(){for(var t=caOut.getContext("2d"),n=0;n<N;n++){var a=r(xx[n]),e=c(yy[n]),i=.5*(r(xx[n]+dd[n])-a),o=cc[n];t.beginPath(),t.fillStyle=o,t.arc(a,e,i,0,2*Math.PI),t.fill(),t.beginPath(),t.strokeStyle="#444",t.arc(a,e,i,0,2*Math.PI),t.stroke()}function r(t){var n=(t-xmin)/(xmax-xmin);return n*=XMAX-XMIN,n+=XMIN}function c(t){var n=(t-ymin)/(ymax-ymin);return n*=YMAX-YMIN,n+=YMIN}}function layout(){(btLoad=document.createElement("button")).innerHTML="Load",btLoad.style.width="50px",btLoad.style.height="21px",(btRead=document.createElement("button")).innerHTML="Read",btRead.style.width="50px",btRead.style.height="21px",(btRun=document.createElement("button")).innerHTML="Run",btRun.style.width="50px",btRun.style.height="21px",(btInfo=document.createElement("button")).innerHTML="Info",btInfo.style.width="50px",btInfo.style.height="21px",(taIn=document.createElement("textarea")).style.width="194px",taIn.style.height="269px",taIn.style.overflowY="scroll",(taOut=document.createElement("textarea")).style.width="194px",taOut.style.height="294px",taOut.style.overflowY="scroll",(caOut=document.createElement("canvas")).width="298",caOut.height="298",caOut.style.width=caOut.width+"px",caOut.style.height=caOut.height+"px",caOut.style.background=bgColor,caOut.style.border="1px solid #ccc",(caOut2=document.createElement("canvas")).width="702",caOut2.height="100",caOut2.style.width=caOut2.width+"px",caOut2.style.height=caOut2.height+"px",caOut2.style.background=bgColor,caOut2.style.border="1px solid #ccc";var t=document.createElement("div");t.style.border="1px solid #ccc",t.style.background="#eee",t.style.width="200px",t.style.height="300px",t.style.float="left";var n=document.createElement("div");n.style.border="1px solid #ccc",n.style.background="#eee",n.style.width="500px",n.style.height="300px",n.style.float="left",document.body.append(t),t.append(taIn),t.append(btLoad),t.append(btRead),t.append(btRun),t.append(btInfo),document.body.append(n),n.append(caOut),n.append(taOut),document.body.append(caOut2),btLoad.addEventListener("click",clickButton),btRead.addEventListener("click",clickButton),btRun.addEventListener("click",clickButton),btInfo.addEventListener("click",clickButton),stateButton(1,0,0,1)}function clickButton(){var t=event.target.innerHTML;cout("Button click -> "+t),"Load"==t?(stateButton(1,1,0,1),cleartin(),loadParams()):"Read"==t?(stateButton(1,1,1,1),readParams(),iter=0,initPositions(),clearX(),drawPositions()):"Run"==t?(stateButton(0,0,1,0),btRun.innerHTML="Stop",proc=setInterval(simulate,10)):"Stop"==t?(stateButton(1,1,1,1),btRun.innerHTML="Run",clearInterval(proc)):"Info"==t&&showInfo()}function showInfo(){var t="wtrwgpmmids.js\nWalk-through and random-walk of granular particles\nas an alternative for mathematical modelling\nof infectious disease spread\n\nSparisoma Viridi | https://github.com/dudung\nNuning Nuraini | nuning@math.itb.ac.id\nAmri Susandi | armisusandi@yahoo.com\nIntan Taufik | i.taufik@sith.itb.ac.id\nPingkan Aditiawati | pingkan@sith.itb.ac.id\n\nVersion 20200308";tout(t),console.log(t)}function stateButton(){var t=arguments[0],n=arguments[1],a=arguments[2],e=arguments[3];btLoad.disabled=!t,btRead.disabled=!n,btRun.disabled=!a,btInfo.disabled=!e}function clearX(){caOut.getContext("2d").clearRect(XMIN,YMAX,XMAX,YMIN)}function clearX2(){caOut2.getContext("2d").clearRect(XMIN2-4,YMAX2-4,XMAX2+4,YMIN2+4)}function cout(){var t=arguments[0];t=pname+": "+t,console.log(t)}function cleartin(){taIn.value=""}function tin(){var t=arguments[0];taIn.value+=t,taIn.scrollTop=taIn.scrollHeight}function tout(){var t=arguments[0];taOut.value+=t,taOut.scrollTop=taOut.scrollHeight}main();